# Import utilities
import time
from database.transactions import add_confirmation_to_transaction
from rpc import send_command
from utils import create_logger, get_data_from_redis, save_data_to_redis, welcome_message, config, SERVICE_NAME
import hashlib
import base58
# Create a logger
logger = create_logger()

# Import Flask
from flask import Flask

# Create flask application
app = Flask(f"Manticore {SERVICE_NAME}")

# Print the welcome message
print(welcome_message)

import routes
import zmq
import time

import struct
from database import save_transaction_to_redis


def read_varint(data, offset):
    """Reads a variable-length integer from the transaction data."""
    first = data[offset]
    if first < 0xfd:
        return first, offset + 1
    elif first == 0xfd:
        return struct.unpack("<H", data[offset + 1:offset + 3])[0], offset + 3
    elif first == 0xfe:
        return struct.unpack("<I", data[offset + 1:offset + 5])[0], offset + 5
    else:
        return struct.unpack("<Q", data[offset + 1:offset + 9])[0], offset + 9

def decode_transaction(tx_data):
    """Decodes a raw Bitcoin-style transaction."""
    offset = 0
    decoded_tx = {}

    # 1. Version (4 bytes)
    version = struct.unpack("<I", tx_data[offset:offset + 4])[0]
    offset += 4
    decoded_tx["version"] = version

    # 2. Input Count (varint)
    input_count, offset = read_varint(tx_data, offset)

    # 3. Inputs
    vin = []
    for i in range(input_count):
        input_data = {}
        prev_tx_hash = tx_data[offset:offset + 32][::-1].hex()  # Reverse the hash
        offset += 32
        prev_tx_index = struct.unpack("<I", tx_data[offset:offset + 4])[0]
        offset += 4
        script_len, offset = read_varint(tx_data, offset)
        script_sig = tx_data[offset:offset + script_len]
        script_sig_hex = script_sig.hex()
        script_sig_asm = decode_script_to_json(script_sig_hex)["asm"]
        offset += script_len
        sequence = struct.unpack("<I", tx_data[offset:offset + 4])[0]
        offset += 4

        input_data["txid"] = prev_tx_hash
        input_data["vout"] = prev_tx_index
        input_data["scriptSig"] = {
            "asm": script_sig_asm,
            "hex": script_sig_hex
        }
        input_data["sequence"] = sequence

        vin.append(input_data)
    decoded_tx["vin"] = vin

    # 4. Output Count (varint)
    output_count, offset = read_varint(tx_data, offset)

    # 5. Outputs
    vout = []
    for i in range(output_count):
        output_data = {}
        value = struct.unpack("<Q", tx_data[offset:offset + 8])[0]  # 8 bytes for value
        offset += 8
        script_len, offset = read_varint(tx_data, offset)
        script_pubkey = tx_data[offset:offset + script_len]
        script_pubkey_hex = script_pubkey.hex()
        script_pubkey_json = decode_script_to_json(script_pubkey_hex)
        offset += script_len

        output_data["value"] = value / 100000000  # Convert satoshis to BTC
        output_data["n"] = i
        output_data["scriptPubKey"] = {
            "asm": script_pubkey_json["asm"],
            "hex": script_pubkey_hex,
            "reqSigs": script_pubkey_json["reqSigs"],
            "type": script_pubkey_json["type"],
            "addresses": script_pubkey_json["addresses"]
        }

        vout.append(output_data)
    decoded_tx["vout"] = vout

    # 6. Lock Time (4 bytes)
    lock_time = struct.unpack("<I", tx_data[offset:offset + 4])[0]
    decoded_tx["locktime"] = lock_time

    # Add additional fields
    decoded_tx["txid"] = "c6f15501b6dbe691ccbd113c41beef2614950750a54f0a7ef692b2bbc2976125"  # Placeholder
    decoded_tx["hash"] = "c6f15501b6dbe691ccbd113c41beef2614950750a54f0a7ef692b2bbc2976125"  # Placeholder
    decoded_tx["size"] = len(tx_data)
    decoded_tx["vsize"] = len(tx_data)  # Assuming no witness data

    return decoded_tx


def hash160_to_address(pubkey_hash):
    """Convert the HASH160 public key hash to a base58check encoded address."""
    # Prefix for Evrmore address (0x21) - adjust based on the network you're working with
    prefix = b'\x21'
    h160_with_prefix = prefix + pubkey_hash
    checksum = hashlib.sha256(hashlib.sha256(h160_with_prefix).digest()).digest()[:4]
    address = base58.b58encode(h160_with_prefix + checksum).decode('utf-8')
    return address

def decode_script_to_json(script_hex):
    opcodes = {
        "76": "OP_DUP",
        "a9": "OP_HASH160",
        "88": "OP_EQUALVERIFY",
        "ac": "OP_CHECKSIG",
        "c0": "OP_RETURN",
    }
    
    script_bytes = bytes.fromhex(script_hex)
    offset = 0
    asm = []
    addresses = []
    req_sigs = 1  # Default for P2PKH
    script_type = "pubkeyhash"

    while offset < len(script_bytes):
        byte = script_bytes[offset]
        offset += 1

        hex_byte = f"{byte:02x}"
        if hex_byte in opcodes:
            asm.append(opcodes[hex_byte])
        elif 1 <= byte <= 75:
            # If it's a push, get the number of bytes to push
            length = byte
            pushed_data = script_bytes[offset:offset + length]
            asm.append(pushed_data.hex())
            offset += length
            if length == 20:  # Likely a HASH160 (public key hash)
                pubkey_hash = pushed_data
                address = hash160_to_address(pubkey_hash)
                addresses.append(address)
        else:
            asm.append(f"UNKNOWN OPCODE: {hex_byte}")

    return {
        "asm": " ".join(asm),
        "reqSigs": req_sigs,
        "type": script_type,
        "addresses": addresses
    }


def decode_block(block_hex):
    """Decodes a raw Bitcoin-style block."""
    block_bytes = bytes.fromhex(block_hex)
    offset = 0

    # 1. Block Header
    block_header = {}

    # 1. Block Header
    version = struct.unpack("<I", block_bytes[offset:offset + 4])[0]
    offset += 4
    prev_block_hash = block_bytes[offset:offset + 32][::-1].hex()
    offset += 32
    merkle_root = block_bytes[offset:offset + 32][::-1].hex()
    offset += 32
    timestamp = struct.unpack("<I", block_bytes[offset:offset + 4])[0]
    offset += 4
    difficulty_target = struct.unpack("<I", block_bytes[offset:offset + 4])[0]
    offset += 4
    height = struct.unpack("<I", block_bytes[offset:offset + 4])[0]
    offset += 4
    # Version (4 bytes)
    block_header["version"] = version
    block_header["version_hex"] = f"{version:08x}"
    block_header["prev_block"] = prev_block_hash
    block_header["merkle_root"] = merkle_root
    block_header["timestamp"] = timestamp
    block_header["bits"] = f"{difficulty_target:08x}"
    block_header["height"] = height
    return block_header

def check_transactions():
    return get_data_from_redis(f"deposits:testings")

def check_txids(status):
    return get_data_from_redis(f"deposits:{status}")

def add_tx_confirmation(transaction_data):
    deposit = get_data_from_redis(f"deposits:{transaction_data['txid']}")
    if deposit is None:
        print("Transaction not found")
        return {}
    deposit['confirmations'] += 1
    



def on_hashtx(hashtx_message, node_tx_index):
    print(f"New transaction hash received.")
    deposit_txids = get_data_from_redis("deposits")
    if deposit_txids is None:
        deposit_txids = []
    if hashtx_message in deposit_txids:
        print(f"Checking transaction status {hashtx_message} for deposits.")

def on_rawtx(rawtx_message, node_tx_index):
    print("New raw transaction received.")
    decoded_transaction = decode_transaction(rawtx_message)
    decoded_transaction['confirmations'] = 0
    vout = decoded_transaction["vout"]
    addresses = get_data_from_redis("addresses")
    for output in vout:
        if output["scriptPubKey"]["type"] == "pubkeyhash":
            #address = output["scriptPubKey"]["addresses"][0]
            #if address in addresses:
            save_transaction_to_redis(decoded_transaction)

def on_hashblock(hashblock_message, node_block_index):
    print("New hash block received.")

def on_rawblock(rawblock_message, node_block_index):
    print("New raw block received.")
    print(decode_block(rawblock_message))


def on_sequence(sequence_message):
    print("New sequence received.")

def purge_data():
    save_data_to_redis("deposits:unconfirmed", None)
    save_data_to_redis("deposits:confirmed", None)
    
#
def start_listener():
    from monitor import ZMQListener
    callbacks = {
        "zmqpubhashtx": on_hashtx,
        "zmqpubrawtx": on_rawtx,
        "zmqpubhashblock": on_hashblock,
        "zmqpubrawblock": on_rawblock,
        "zmqpubsequence": on_sequence,
    }
    zmq_listener = ZMQListener(callbacks)

    zmq_listener.listen()
def test_block_decoding():
    blockhash = "000000308b5ec512c82b41af227f4b3cd9191e4401eb191f246133e4c3b70e0000000000dbc98e8b2769d39623337c36ebe00bb7bc91cf81313a054ba372ab5ad2016458edc30767b032251bc2820f00135090010a009657d22952575a40e949632e8d6590c70976c8c90fac9d68763c20875bfce551f6c60d010000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff1803c2820f04edc307670057960b455652706f6f6c2e636f6d00000000030000000000000000266a24aa21a9ed9d9970aa2c1b9d691b1be25d59fcc959fca0e7897808c54529f002c11158185993e3e8770600000017a914a78f72cdb3a7ee5f09d5259ae7eb64231858bdc2872d0030373a0000001976a914213b2dc9899b2bbb92d341a69010026c9b6a849688ac012000000000000000000000000000000000000000000000000000000000000000000000000002000000013719c8b76e5f4c116ef2c9b458fcfdd6a51ea360a690583a2467ab3c9ac5ca85020000006a47304402200a9ee4af0083690fc767add62e3c3217adf64011f2a3eee97469d7259f2cacb00220176b92fbc0a314438642691813f6c8c9a80fd36d38c0d07c6cec86e9c03ab951012103ba73f4eb589f588fdd9e7047f21e8d141804e47aaf68489c4ec88c799296449efeffffff3240712f53030000001976a914aad9bcddeae3153e35cd44d1cbd01b2d47d6a6ae88ac802e8d4d030000001976a914b024f56bbf70047e6b27c18068621dc4bfaaaa7588ac804e7db6020000001976a914235a20b95c935b38254ecc08299d287e5ece56ae88ac50e65d64020000001976a9148107b5fedbfde63b900110dc5607ea619819133b88ac70435bb3010000001976a91411650548387d8f63260e14c27ff81340bb9a494888ac70688a7d010000001976a914eae80e95741d5341578571bad950fcc5a8d3c3ac88acb0fcbd52010000001976a914a558316f2d6d63574fc3a61bd795eddbe4e82ad588ac5097933d010000001976a91482810cbed1aad40e4458ad30d530f83dae5d359688ac00712f31010000001976a914ede2ce260f675418b54564461ab887a8ea71ebf688ace037ed30010000001976a914ebcde053771a6e028647df8bb61242170f74703188acf04d7203010000001976a91496bcd0a9026d370046597e9dea7b37cf7de7f47088ac901071ed000000001976a914a3966970ce70010ec27e599d46c06ee30d6f0ce488ac0076f9e9000000001976a9147e9a95b159586061168e1f690002979f4fea8ce488ac20daebc8000000001976a91470d4471d9a1885271a8be5bf06b29bc906b231b588acc07467c2000000001976a9141fbe249f36a29997729910a1310f0f6eebb5551c88ac00415244170000001976a91482093f92e135c790988fda0bd8b98113f410802a88ac00c968af000000001976a91431ea7a02e3409b92ad0c30fe8be2cb96a3f31e2088ac80f82caf000000001976a914e465aa5bd9b2b5fbb785e3ca0759f6a4f0f1185688ac904503ae000000001976a91485aa8a3b056bf3a7fb39896f54f8f943702f4dbf88ac102b1ba9000000001976a9142aa927a932625e61ec741630064395b451ac32fc88ac703244a5000000001976a91486bb9167f54a7d5a200419b67a069c4819ea49fa88acb00f7f9d000000001976a914f530c81b2c1c68f207b7524fd62a82d137e8d0d088acc0700b8c000000001976a9146fc482edededdeb35ca929b50cf916b17ea01ffd88acd06c6981000000001976a914dfad48e96acab086ba260b7a08fc7a7f5cb6ffbf88ac80d82879000000001976a914d7852d1ac0c347dffff8a6eebb7b0497b71013e588ac307a5672000000001976a914cc04e3c1a4d2578dd03c5594f94a8e9cddd74ff188ac30f89564000000001976a9148d814575611c2dedc1616c6f3af40c8f16de3bfb88ac70cfb960000000001976a9143829a06cb4cb3a93ac3eb21c8eaf01671d0cb7db88acd0265356000000001976a9144b81464a1b872122f2be11114dc659ba979f4d3c88ac5097a455000000001976a91445d0f4c85a92a38767944801a1b63344b0a327d388acf0be3b51000000001976a914df0026793295a5ff612f4cb6d27abde368015d1288acf0e66450000000001976a914dd1649bcf9860908ae2eef76238bbd52ae4c935188ac402c0f4d000000001976a9144c3d0da8b59f2a5452b8297a5d1911e5a070495988ac10ffa347000000001976a914408c0dd87ae1155f18f2b4ba6fa0d86365e7f0d188ac904c9f3d000000001976a91491585e65f93c5c3d4d509fab3acc6f90143fc6e488acc0ab7f3c000000001976a914e2c1c2549563e6c6c1643ea3e13d9ea8474d66b288ac20065d31000000001976a914f4acd2194659712db43f1acbae825b64ddbc04ce88ac7055352d000000001976a914bc737a4d8b6d26c76dc16eb556b6dad55ce77f5a88acd0702b2a000000001976a914bf3be8d88a3c21138d9b1fd6c408ffbbf4d86e6988ac30d8af29000000001976a914a4f832260ce8baa452a3553ffbca5fc5d2b80eb088ac50eb3926000000001976a914556cbeee642e4976e6f2b519d9678702ccdfa5a588acc0494925000000001976a9149a11d017c169a3d63a3d0265627a5c91a95ff6a888ace0402b22000000001976a914f591b1128635e818df0e82929530670617d5fc2388ac60d1ca21000000001976a914182711ea65bfa7d0ab5a7e84be2f628050fd975d88ac6034c415000000001976a91404d2e29b36046b4fa6d6a5aeaf82396692cdf63a88ac8040d514000000001976a9147f07d587fe2ae1c581d7a17d6ff4196b1aeb234d88ac200e7b10000000001976a9140da319cc0a9422efc7508eceb0ae5a747204b33288ac30999a0f000000001976a91458e789c9ed1a7ad80202e5cdcdd2e62a29b6fde288ac6095f906000000001976a91476c3a2c4b217b468d5f2a9256c12101d8a35c31e88ace0de1206000000001976a91422c5245d3aef8991c6d76d00d8937420f0a2295c88acc1820f000100000005f22f2ef74301601ac8ab0a299616cb5a6a3e99cf3c33a01a3b51ee72144c1c80010000006b483045022100f9d8eaaf3d3440ac63997cf7db0f769f7871a2506023fa10a52b338ca0bdb56402202d185bd95a1b5bcc339b10dfe5268cc1ca31659afcf693c76c5a88ceecc070de8121036637d33e401b2feeb68a09d7bdcceb3fc43e45f03aed198fac6ef2fa65aa5540ffffffff281b466ec2874b4058eb520b36b9588a33ef8eb65753dfd5b66b350c5c005bca6e0000006a47304402205e89aab8d21da48708f9559e6d8833acb6b16659bfb9eb71e57d9fc227afd878022025f9da51e33c6f861def0c99e02aa48b9f344545724ec4d52aa43f20fc448a5d8121036637d33e401b2feeb68a09d7bdcceb3fc43e45f03aed198fac6ef2fa65aa5540ffffffff2dd588e4aaef97f3825d69d9f18a054078bef25fc8bf3056723ab5f73f960a6d900000006a473044022060c4cbb5f36fc4377d125666f2c7a14d3ea9393054a129d179485f375257609402205dbf0dfac0223f829a27a889853932fc087cb6b8c8fdd4e034b1c18a579036458121036637d33e401b2feeb68a09d7bdcceb3fc43e45f03aed198fac6ef2fa65aa5540ffffffffeea757dcafc004f5d150b0d2a55d96f0b227cfa304ca1429a53757a577839f4ec10000006a4730440220618e7f6512c5e5aa105d36f1398d99a9b7dc535446b2cb400e92b98f26d75e65022028abb3eed0991737c49acf078c5b09a46a6409c68f229be8479312ed7c6672ee8121036637d33e401b2feeb68a09d7bdcceb3fc43e45f03aed198fac6ef2fa65aa5540ffffffff5fd517442cfd9c410647cccc5cdf4d56c67d597acb9d12a1c99e3856021d1905030000006a473044022008a6503a695515211d3cd52981331f8a66ef758d2afe74314bb57eddfe8f80b502201484bb0b87a802ef6d78ec2b935712960832aeb4b1b1ae6defcec047dcd613408121034361a7e413084b524607292cf752f81db434c100081884b2eebbef6e89121ffeffffffff0400000000000000002f76a9142b6b121b49cb226125f89617819467fcabdd1fe288acc01365767274065341544f52491aa28601000000007500000000000000002f76a914c154a4b3cf173704f3d9b6579448808a131fb34f88acc01365767274065341544f52499f860100000000007500000000000000002f76a914fec1c6903d30d44359a0e0bd54cb99f8e100b43f88acc01365767274065341544f52490100000000000000756011ed6a130000001976a914fec1c6903d30d44359a0e0bd54cb99f8e100b43f88ac0000000001000000056d6f1fb7156cec0bea5a4ea12918e8d65240ed8c316e2f55a58b01570e2bb31c010000006a47304402204c12e027b50144e7081dc485ac0e398ef9014971245b0d65a038104eddb9d63202201bdbae7dc5ea69f57afce75cec9810d9b9af47e8f7d34b40a6403257907710d18121033fd4213a85f0bb4174c5f916013ecfed8036658c2a35af9884702e17530525e7ffffffff16612f708012ae12b5fcef656c866d0ca9db9b29bae0461fdaa5a51ef42d1e5ee30000006b483045022100ab871883505755f29e8435620e7bd6a0fe85d776911db7b1166dccd0114c095b0220314e731fe0aa90e7d4d4f09138b9b4de6f0c5d4d9f2dcc2e279fd2b8984e941c8121033fd4213a85f0bb4174c5f916013ecfed8036658c2a35af9884702e17530525e7ffffffffb0b142c18379707a38e88bc0a16d3001803bb0a3500da18e2972efbb62b6cd25f20000006a47304402202387f478907d63e5cf8a60b1868749cf356de50914a5875dd7f9cf60223fb6b2022073297f6c1ffa6d77370699fa82037a746dbc4d40bc7cf33662a3cbed6ca9407c8121033fd4213a85f0bb4174c5f916013ecfed8036658c2a35af9884702e17530525e7ffffffffd1094da917c5923c85e17b98175de96045ea4ddd1453506cbcb82d7fe41299effe0000006b4830450221009fa2486487288f43dad23d9f54d4a59bee1bd63dfe82df8d7ff6448df1e53f3c0220468db3e35069255c1ba2a6125152d9429bd0934e35a087fed979524ebf57e7488121033fd4213a85f0bb4174c5f916013ecfed8036658c2a35af9884702e17530525e7ffffffffd3a8fc99af2952b2f6ebfb53cc195f1258065f85dbd6600928dcf2c9a8f00e48030000006a47304402200372b60cea0b79c617a2b3bb72970b02917b686f27910000ed9758984380778a02205060147d1bab2710c66ea8c3110b1befe850672c5b2a2be3fb818c95a01436c6812102147765ecd46b70279729dd1dac423cd7234b54493fda92b9ddacef640aef1eb4ffffffff0400000000000000002f76a9142b6b121b49cb226125f89617819467fcabdd1fe288acc01365767274065341544f52491aa28601000000007500000000000000002f76a91427825d89fe95a1b0c1e089c002a51df7e9cfe07d88acc01365767274065341544f52499f860100000000007500000000000000002f76a91451849252c267fb881ddd38d897314eaa9b72862b88acc01365767274065341544f52490100000000000000751025436f130000001976a91451849252c267fb881ddd38d897314eaa9b72862b88ac0000000001000000056e07664b09dba160997a57097a57c6c65cecc70b3df45fcde029b1f5ce4125e7010000006b483045022100d7e62c571b9e0d669aa19c5f49b50c74759c132ee406e853b7e6fa8b2466e15f022068cdefadf5472d6bfc7778f1a583346343604ff6983ed96223c92309e1a1fc608121027d2978a66f06377746ecb5bac072226f0859f2f1c8e4db54f9380ee8e13bed21ffffffff16612f708012ae12b5fcef656c866d0ca9db9b29bae0461fdaa5a51ef42d1e5e610000006a473044022032307056249cba81fb1d1727b7506816e4c474b1b75e950c2083415115109c1702204ca18290fc27f4c7f2a636a4623ba2a32eef3beb1b471e70434e45f311b431cc8121027d2978a66f06377746ecb5bac072226f0859f2f1c8e4db54f9380ee8e13bed21ffffffffb0b142c18379707a38e88bc0a16d3001803bb0a3500da18e2972efbb62b6cd256e0000006a47304402201ea2ea6e48197fd15166ed7bb4ba2e148a43a3f68356ad671956d55f0b764b4302205962bbc689e37f8a545f553c9345796b0fa95c4f5c169b3232b4d57fddc0d6008121027d2978a66f06377746ecb5bac072226f0859f2f1c8e4db54f9380ee8e13bed21ffffffffd1094da917c5923c85e17b98175de96045ea4ddd1453506cbcb82d7fe41299ef7b0000006a47304402205ee34d30ebad9b1365da7fdcd189c48412a124bca7631af423401a43b93a7f1a0220012558462c10b9d957d402b307abfebb7af372f2309181b7b69d48886e87c2be8121027d2978a66f06377746ecb5bac072226f0859f2f1c8e4db54f9380ee8e13bed21fffffffff13c34672dce40849b621e53716868b840ff1cd64f115c13d40216c33c6db233030000006b483045022100be2048907e84a7a1100263f2c55b7da9d412fadba43ae4a96248d4eaf6ec3db1022065b4eb2b92ef1128dfaab3f65049c598d1e7dae1c69c3ded41bb32293bb2272b812103c6b22b82d247f5d17e392ec74c906e088ec41e008342e500117a53e1b039423dffffffff0400000000000000002f76a9142b6b121b49cb226125f89617819467fcabdd1fe288acc01365767274065341544f52491aa28601000000007500000000000000002f76a914215de92bc431dabcfabde85b8c3db46eac5ae9c888acc01365767274065341544f52499f860100000000007500000000000000002f76a914bf9bc6e1f4000cc5447edb1de4bb378a45546d5788acc01365767274065341544f524901000000000000007530393657130000001976a914bf9bc6e1f4000cc5447edb1de4bb378a45546d5788ac000000000100000005359441f55bea5488383d280740fef0e0b94c5220edc4e5c7c7e526182167fb3d010000006a473044022057f792eac5af4bd6b67a08ab1efce798f4a16aafbd2073f6d5d5254702f9999b022010006b7365e2ca137ba95edc7c426612e5b35bd941eb765849ed896b4f8ac0ef812102e1520ebe5900611873f1856bb7332baf3f1d79b33fa985f3da7069d1d275a2cbffffffff16612f708012ae12b5fcef656c866d0ca9db9b29bae0461fdaa5a51ef42d1e5ec10000006a47304402203bc7a1bd3b2450ebe0b876b2ae9c6e7aa7a34b5698068e88ac775cfbf3d9a170022057eb5545fda0914e7cf04ef2e1035b0e0083a8ac14dcbaa685b2dfafe9f3833a812102e1520ebe5900611873f1856bb7332baf3f1d79b33fa985f3da7069d1d275a2cbffffffffb0b142c18379707a38e88bc0a16d3001803bb0a3500da18e2972efbb62b6cd25d00000006a47304402206ef722011329545875edaeb6c9a605774246127f9517a8b075b1d6292c4fa886022060236b50ee8818359b6032e6f9322dc39de88e94dac449c21450559e61967819812102e1520ebe5900611873f1856bb7332baf3f1d79b33fa985f3da7069d1d275a2cbffffffffd1094da917c5923c85e17b98175de96045ea4ddd1453506cbcb82d7fe41299efdc0000006b483045022100ca5ef1b7135d48c1fd81ea8e4b57756cb466a4e6968536a60524fa505128419702204d2cd7370177250391a0b9736850e9d47c9fbcf64bc660aba0b47b8a2ab88359812102e1520ebe5900611873f1856bb7332baf3f1d79b33fa985f3da7069d1d275a2cbffffffff20d85a4e25535e14652a76ecac28f6c877c9147f82193eada45cce8ea7d29664030000006b483045022100aec0809ca4400e0ad8b8dec5e29e81fe0562001b731a9ee8a7e2332d05c99a9c022024c7926ab8beafcaf9f6dbda13f89ad9711d3ea3d71fb356ef26d469517f6dbf8121033e450b8440d514a2b006216150fa0981df900980bcf65be4d442bda40a68e988ffffffff0400000000000000002f76a9142b6b121b49cb226125f89617819467fcabdd1fe288acc01365767274065341544f52491aa28601000000007500000000000000002f76a91425e9e631b0602c60d19ac084110b60e130bab50e88acc01365767274065341544f52499f860100000000007500000000000000002f76a9143fd507d4cf0963d5c78f3ba484dc0a2060f7ebe788acc01365767274065341544f5249010000000000000075102af869130000001976a9143fd507d4cf0963d5c78f3ba484dc0a2060f7ebe788ac000000000100000005d3abd3fa02d052b51ccaa9d7263f2989a15e7a1ac74f156b3cea503e1b05f89d010000006a473044022038679b26d8263cc8f1521d1285fdcde5234e17df9a0d9ea9df93459f05d20ac9022063520d1f1c341b4f643a465bb35764d9901f1def2e8be982b1ac6c58dc1caf7e8121031fe4a1667428851cdcea9978dbc4d81e40b1b7324c16d46173988ba0fed9fffaffffffff97b5113ba6fb60f7ea47e05f9ecfdb22e7b20dd3f3591e725589647e4dae4677d40100006b483045022100c4c6e111f39b29c8c621debd4925a46fddc718accf0b4477ebae94dfd1bd4ced02204665c433f354f127d7b42de011b98d28107134345e1317811191a2f320f0f0308121031fe4a1667428851cdcea9978dbc4d81e40b1b7324c16d46173988ba0fed9fffaffffffffbad2d3824de2c6c2b5fc31d66d48ae84d0f6e1fdde53436e300aa78ad3715a11080000006a47304402203c25a61a03981eabd08ab51c2fd5d3b39e3b262e7025f1e0ddf9bd4e1ab3b6ad0220291d5ea7cbc3eead0aec62e08f059c5a9ace48c0f518bc2928c34447832ce61c8121031fe4a1667428851cdcea9978dbc4d81e40b1b7324c16d46173988ba0fed9fffaffffffff1cf9bd4648ea64eb99d628cbf0463378258b4e9149e77d95597faee942fd48223d0000006a47304402202829202ef56375230b207fcf3ff15bec8c953d1ebd8ec500f3efc6237d4860460220494296933642208faf26e71cc0cb0adf2be049fc28a26b92a4dc182875fbf7678121031fe4a1667428851cdcea9978dbc4d81e40b1b7324c16d46173988ba0fed9fffaffffffff85a301daabf704eb2cf3dbedab50c93dfd209eded5a6963c38f2f90e199ee0aa030000006b483045022100bd85ab9d0d313bc0502f776b6d8ef9f61ff4e44b9c4f301193540f826f14e1a402201d4d5f67ae25e6584a904cdfdc059e26a7874f4639b7fdd95404d5f7b68774e38121033e450b8440d514a2b006216150fa0981df900980bcf65be4d442bda40a68e988ffffffff0400000000000000002f76a9142b6b121b49cb226125f89617819467fcabdd1fe288acc01365767274065341544f52491aa28601000000007500000000000000002f76a914ebedf4d048f75cbcada912137ee708c632e858ce88acc01365767274065341544f52499f860100000000007500000000000000002f76a9143fd507d4cf0963d5c78f3ba484dc0a2060f7ebe788acc01365767274065341544f524901000000000000007590dae569130000001976a9143fd507d4cf0963d5c78f3ba484dc0a2060f7ebe788ac000000000100000005db56bcd9ca36208e00895e3f257e87776e60201b1d3483ffb1aa748a8af32332010000006a47304402202332230333c857b82cb11ab760b361c8d6830b94a07c88d87faf00a7f1e58a1502205000aa00fe28b7ba660d3b687580b6d2428650eafb231462ca9199f579b48ed38121039c3130812684c3a899a034414c4fffb23fc7e411f5f0862084c5687dfdc3b78effffffff16612f708012ae12b5fcef656c866d0ca9db9b29bae0461fdaa5a51ef42d1e5e660000006b483045022100be3d447b4dc267487dc25bf2007d11ec3e30ab3b8110c60e74070b2527b67605022048af101508f2d6dbb2f36f474807063e4822bf16f9af9df2463d2bdc0b33c09b8121039c3130812684c3a899a034414c4fffb23fc7e411f5f0862084c5687dfdc3b78effffffffb0b142c18379707a38e88bc0a16d3001803bb0a3500da18e2972efbb62b6cd25730000006a47304402206e3f33cd4e32d183545f51de241c8bc8749d44f4167e73e48fb2f253d85448c10220134146271a4362b1fc1cfe85dafef9761d2f58458ff4674a048a2ba21cbfff8c8121039c3130812684c3a899a034414c4fffb23fc7e411f5f0862084c5687dfdc3b78effffffffd1094da917c5923c85e17b98175de96045ea4ddd1453506cbcb82d7fe41299ef800000006a473044022076f39a9d6fbf6ae327e4b17ba12092accaf31def9f7317a3e39581a4ed1f602e022047d27e22a62c6202bb2597b15d17c94973266cf863d830b34ddf195acccd87f68121039c3130812684c3a899a034414c4fffb23fc7e411f5f0862084c5687dfdc3b78effffffff3b8892211f9d6a7548ed6f9f774151fa39de3a182db64f1f22c42a5e1c64fd41030000006b4830450221009ae989800908acd345697487427cedf43c5cd480fc23a0dc25dfbff6ba9c8f06022041f43a4bbc13715b43b4590a501894e4ad39c873bb2fdbe6e3f046e842e8ea788121034361a7e413084b524607292cf752f81db434c100081884b2eebbef6e89121ffeffffffff0400000000000000002f76a9142b6b121b49cb226125f89617819467fcabdd1fe288acc01365767274065341544f52491aa28601000000007500000000000000002f76a91421794b02ab8821ed92c8ea294dfa8f6c5d0b3cca88acc01365767274065341544f52499f860100000000007500000000000000002f76a914fec1c6903d30d44359a0e0bd54cb99f8e100b43f88acc01365767274065341544f5249010000000000000075e0c1da6a130000001976a914fec1c6903d30d44359a0e0bd54cb99f8e100b43f88ac000000000100000005ede9026da47f24c9265c347e3ff46b1051f3bbc93d784541d4b2c3285e2e8155010000006b483045022100a0e27b327bc3d5b9582287520c7b4223776c66ac41e9e84e1e1da9530cfad23802205d1259865bfacaf885c41806cdf0502f754c3e9342075d56cc380280734939298121022b0aab88d20e157dccb36bcf248a34f97cbece7a604d5f1316a73bb545b91e90ffffffffd51e5785a895b60fb74fedd8b4851053508d2d72f2bf65da4bfa10e447f96415310000006a473044022074a24fdff48a75c51fbbbcc30feac56e6ad55cd6b00bf2679f8a553f0257998102205ef02568c42d46a6606a4d3821717963365b58c8823c3751625d8e66fe8ba6858121022b0aab88d20e157dccb36bcf248a34f97cbece7a604d5f1316a73bb545b91e90ffffffff4833f5a8ef44dc2c07129ae0aeca82c5cc63a4ab0961e0608251ed1314bc73b8440000006a47304402203d4f289a45384eb4af76d3872272f180a82a3ca3754890fd5b4820512dddc83b022028c800f47f6ddbffff2fe19d8c124e59e591a7a91aa25aff6e73145e894c2ec88121022b0aab88d20e157dccb36bcf248a34f97cbece7a604d5f1316a73bb545b91e90fffffffff741df2bcde2ad3b4eafd4c4f87b74bbb778a7d19bcf719b0baa41d2a4df6f76580000006b483045022100bfac845b3ba3a22d6cb4c54f75e3e3869fb9ec54fbf84a9394ff9108df37ec4b02206c7d418c39955649aa3ebd1d0c3a39cd01047b57607d2133da3932d750ac082a8121022b0aab88d20e157dccb36bcf248a34f97cbece7a604d5f1316a73bb545b91e90ffffffff52601d38a30cff6964675d37bc8b3d382b0cd137500574cc238ee6990f6970fa030000006b483045022100db337664590ba2855ec4052b0d6c4b98b85e341b0396d9ea24b1b76f9c45fa0802202f4d6d39435b72c53e74b6902120453d00980b19127c212ef062628682142d5a8121027ffc4aaac16842f9e5e624dd4a42058db1a8bd55c4bb1f05fcca804cc9269014ffffffff0400000000000000002f76a9142b6b121b49cb226125f89617819467fcabdd1fe288acc01365767274065341544f52491aa28601000000007500000000000000002f76a9146bdd6d13f23777ff3a10b86615dfd49169c91bf488acc01365767274065341544f52499f860100000000007500000000000000002f76a914291af70df5044554cc9ca3eb51cb8442f59a2ccb88acc01365767274065341544f524901000000000000007570e84e4f130000001976a914291af70df5044554cc9ca3eb51cb8442f59a2ccb88ac000000000100000005539172ed580e54b45932cba06f766b91f89e70cae66ed7d29413f6f6b444f03a010000006b483045022100a469181cd9191d0d3db87fad6de49cea203bec6176757c3d896907e6f5100b5002201efc89c94992022453e8c240d8acb5b718584192b1efc5809edaad0e4fdc1e2e812103c84bf40f244dea331365625251c0c16acd65ba0d49df1d5b901845343f6d7138ffffffffc79140a06cee8f6e83a5ea91f9c3b963c1ae4a5e9b72afdc33ded616882ac00e340000006b483045022100f6fb541de880114f6c7e7a85247f0da56e46af7d55d8a3d7b7cdd99560b6364f0220194e3c89d3f36f915ee70f4ba3557bb452bcabc421edb9c6b9b4d853d14e53f1812103c84bf40f244dea331365625251c0c16acd65ba0d49df1d5b901845343f6d7138fffffffffadbae07ddd04cd316051e3de82bb208baabf766436b5f76feadaa3651f0782f4f0000006a47304402201a4b101f35d0c18025598ce9d882751ebe4cc0df7154f1b0a57e2777b769a288022052650f442a01ae76edb4544c28bdcf1bf86ea7b1fcbc0b4d59d96944bbc6c252812103c84bf40f244dea331365625251c0c16acd65ba0d49df1d5b901845343f6d7138fffffffff99753e4643630871812fb5219c49ad308812f5ca561e31ebde52a9cff49f700730000006a47304402207fa21c9d4acb727a8ce8721dbb719210030093a5c93066a91d14ad26b10da26202204c67a73c28c30a058dcf31b2f7150732afdacad0afdd83040dcf10a5e24b9ea9812103c84bf40f244dea331365625251c0c16acd65ba0d49df1d5b901845343f6d7138ffffffff60d7e784db5664ae729984e57fa74f898dc4366cb266cc128d9c821948fa7946030000006b483045022100efe17c80dfe9ce6413bf4789ae3248c50095b6ea7acc74f5d97b776a1d6da08802207212ed0f65078d9d42b946a67aeda44bbbf2dbde6736fd950d1e01f9d5dc19f481210390d90b71dc0bf62c456ecd06288c0e6e3d65c81ec62bd47ac716d281f706d412ffffffff0400000000000000002f76a9142b6b121b49cb226125f89617819467fcabdd1fe288acc01365767274065341544f52491aa28601000000007500000000000000002f76a914a142f08e690d3c0bb4d7623d476b4941048ac7ff88acc01365767274065341544f52499f860100000000007500000000000000002f76a914aab1a5d127fb88901867a801db377b8082156e3188acc01365767274065341544f524901000000000000007510f3a45b150000001976a914aab1a5d127fb88901867a801db377b8082156e3188ac000000000100000005a67bf85d09842f02dedfd47d83190e9204cf7d0afd7bd129db3b5bca116b0477010000006a47304402201e42da4b5c06280c7fafdfc6bcd2f99c2ca4ddbc0bf0a209d3a02d29d6e0df3a022065e2c74edb8a255c90b771ecdec471b58c65d899a0472ca75b80fd9ae4a1bd76812102d59b35b320bd92983d1fba730ad6f40473d71f1e079fbae2696f28be548d4c0fffffffffc8d4452b7944633a16f587d9458fef50625b8b789cec7a68596e66de3f709a18660000006b4830450221008aa1488a58516a41b9a416db9d204406fdb72cb58f0ddcfe1095d449486aa70002202d08ad8d7abb249ab195a6a15419d0ac4abffef8295e516248e4c00c03b12e97812102d59b35b320bd92983d1fba730ad6f40473d71f1e079fbae2696f28be548d4c0fffffffff6142c3f8b6b43c49b6d998749f1ea036d1cbc3e13fe05f08d1c3381444248b977d0000006b4830450221009916d556f96891f072f414e00423e93a18a9be30f4a1555e9d9cfdffe95daae402201d90a47cbd00611452324b46ddf4a1fdb034b4d7c7360c51d959129795c7fbd8812102d59b35b320bd92983d1fba730ad6f40473d71f1e079fbae2696f28be548d4c0fffffffff8a12b31a54bb565f0bc984a17f12360436795b6b31526cd94cad8a0f5a676d669a0000006b483045022100e9842c69545a02c01bbb774f57bcec5b73b4eebd4df6d7616114569876694ea7022033ad983d5ebfadb3dacb78bfa015c00f87c4c2803c1a2c374b501adba5329fe8812102d59b35b320bd92983d1fba730ad6f40473d71f1e079fbae2696f28be548d4c0fffffffff7a80bd3b10c370cc4944eb6b17a7efd304bfeeb0fe10a6ccbd0d0303d5a01d41030000006a47304402205648bc34efd44f93e66fc2da99f6fd633aab73abd2a04d9297964f6fe74ab1a202205b5f2030f43201df9899020a88706d2b3eabd20cebcc9cffa05d596eb2eb377a812102f3f04318c4b6494c3c0e82c8a79d7cfb0248da9f7d12d73af46b14e72f02e2ceffffffff0400000000000000002f76a9142b6b121b49cb226125f89617819467fcabdd1fe288acc01365767274065341544f52491aa28601000000007500000000000000002f76a9148924764437cc4028107e91c9366e480690403e6888acc01365767274065341544f52499f860100000000007500000000000000002f76a9141c7af90978082cfe8709aefcfef92a608984c51988acc01365767274065341544f5249010000000000000075a0bb5068130000001976a9141c7af90978082cfe8709aefcfef92a608984c51988ac000000000100000005cbb6543dd97f8086905be7d7fce793400ad85ac1ba8eef3d7af17692f30f7dec010000006b483045022100956dcd00c3a470b27da9ccdd2b9fabb60db42950b736cd774ba91af91c79172202207727f3656d3669ceda5aadd291114cd7c5f85ae7a47d849c3d4c255282d31ec58121038267b4b9701fe80f9e31f40e7a89343c9219d65c2df0cdf7f2a11085b590aac9ffffffff281b466ec2874b4058eb520b36b9588a33ef8eb65753dfd5b66b350c5c005bcacd0100006b483045022100ffdf9b0797293044eab13514e51b52e39c8cc38d667572682c44ff18ee08a06902203ba288fb2e4b26e9e28de699fd346a007a107173a2e09a682d4e235cb95f11db8121038267b4b9701fe80f9e31f40e7a89343c9219d65c2df0cdf7f2a11085b590aac9ffffffff2dd588e4aaef97f3825d69d9f18a054078bef25fc8bf3056723ab5f73f960a6df20100006b483045022100e712743c2320ccb41ed83fe499d4e705b10ae1d3878619c23f45f41ef2434ebd022003ad0014dbba1175be33e6bc61fcb4ae45cb0b0f457562fd8a6c7c296acf73b58121038267b4b9701fe80f9e31f40e7a89343c9219d65c2df0cdf7f2a11085b590aac9ffffffffa2618628ce4543cf2c90daef8fccc59e74bf00e9150a545b05dec26a52b87144330000006b483045022100940a49742934d27252f323159243751143c7e3582edb20898e462fdebcda483e02200ddcaf4d15dec4690a37942140471030c50ade5bf65df16066a8d28c820598c78121038267b4b9701fe80f9e31f40e7a89343c9219d65c2df0cdf7f2a11085b590aac9ffffffff77fdd3a9b9f19eb81f861dce5dad28c9a8e4e8263dcbe3d6d25e3157f2316d85030000006b483045022100a7b2284b7c1791130927cccd80b5144be6ee81b714f9fad9432a0ddec1c93a78022048ebad8a11b7de6ffbfc1375992b9172693c39efaa3b84611c36e4003a9be79e8121025ef269510c13e7015af28c21822d68250c0911a418ee71870aa9cca637ebea80ffffffff0400000000000000002f76a9142b6b121b49cb226125f89617819467fcabdd1fe288acc01365767274065341544f52491aa28601000000007500000000000000002f76a914d37104afa5e50b902896ad7a2ffb6798136a4d9188acc01365767274065341544f52499f860100000000007500000000000000002f76a9149f9f1f6f4247ee81f6802d2e78249f8235f241fd88acc01365767274065341544f5249010000000000000075a0e6bd66130000001976a9149f9f1f6f4247ee81f6802d2e78249f8235f241fd88ac00000000010000000581aee7fbd23bd855427e80387300bddfab35f0b2def3cc23e4091dfbbc3e5aba010000006b483045022100b816455386da4b18866c5aa8964442ea89de5dc84fa03fc71171cd21f381723f02207512d8abce2da136cba299dfa40939fd7e24553b7d6bb9fae595f9bf6ea79214812102400bf2dba07b8be6ec46280ab594977f979b8e2c75281c454397880030850140ffffffff16612f708012ae12b5fcef656c866d0ca9db9b29bae0461fdaa5a51ef42d1e5ea00000006b483045022100a36687b6bcf18c9cf7d8596e08f7c68e07a349f520c33aa9f7435ad3a39ef4ef0220631f98c029610085f29d011a879ec66aabe22440fc169af07c33cd2915eeae1d812102400bf2dba07b8be6ec46280ab594977f979b8e2c75281c454397880030850140ffffffffb0b142c18379707a38e88bc0a16d3001803bb0a3500da18e2972efbb62b6cd25ae0000006b483045022100a3c64adfcf0fb7aa38a9d2a0791517cf8bb2a08a39b7b67f8a9894733e04266202200a7c9a1de803203daf88cabefe8fc32db7e6b4592afb68aab3f6f483e3535564812102400bf2dba07b8be6ec46280ab594977f979b8e2c75281c454397880030850140ffffffffd1094da917c5923c85e17b98175de96045ea4ddd1453506cbcb82d7fe41299efbc0000006b483045022100faf64861cc06a80ccd7040ea1017da7022d9d0762343b04eb5ded00b12890727022013db1c99ed23b18aaf23305f12460a03d89097fda5f88b32899c6e7df4f217e5812102400bf2dba07b8be6ec46280ab594977f979b8e2c75281c454397880030850140ffffffff11fa9d586a0e911487e8af26b02d7e58c2fd5806ea9ab26496f529d87810f203030000006b483045022100dac151d334f6691d1a40436fc74a7f6bf624d2c48df652a5e0ec3fa7b5992f29022078a1c408dddf6de948cc083f7d86b8dc9e694f98074211a667f115db344e430e81210340c58e4efe0de423f64a99fb5c058746bc866a80064fc10e1b6beaacb7b56449ffffffff0400000000000000002f76a9142b6b121b49cb226125f89617819467fcabdd1fe288acc01365767274065341544f52491aa28601000000007500000000000000002f76a91424a4c79dd27c3d4e2ac98f7ff823aa53b16fdd3b88acc01365767274065341544f52499f860100000000007500000000000000002f76a914a100fae06dd51b499ab0c7d153c280f2f2680fb888acc01365767274065341544f5249010000000000000075d071e11c150000001976a914a100fae06dd51b499ab0c7d153c280f2f2680fb888ac00000000"
    print(decode_block(blockhash))
if __name__ == "__main__":
    test_block_decoding()


def test_add_confirmation_to_transaction():
    # Start fresh
    purge_data()

    # Test transaction
    transaction = {"txid": "testings"}

    # Save the transaction
    save_transaction_to_redis(transaction)

    # What do we have?
    print(check_transactions())

    # What are the unconfirmed transactions?
    print("Unconfirmed transactions: ", check_txids("unconfirmed"))

    # Add a confirmation
    add_confirmation_to_transaction(transaction)

    # What do we have?
    print(check_transactions())

    # What are the unconfirmed transactions?
    print("Unconfirmed transactions: ", check_txids("unconfirmed"))

    # What are the confirmed transactions?
    print("Confirmed transactions: ", check_txids("confirmed"))
